<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maranggi.in</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .sidebar-link.active, .bottom-nav-link.active { background-color: #f59e0b; color: white; }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        .modal { transition: opacity 0.3s ease-in-out; }
        .chart-container { position: relative; width: 100%; height: 300px; max-height: 40vh; margin-top: 2rem; }
        #toast-notification {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(-100%);
            opacity: 0;
        }
        #toast-notification.show {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body class="bg-stone-100 text-stone-800">

    <div id="toast-notification" class="fixed top-4 right-4 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg z-50">
        <p id="toast-message">Aksi berhasil!</p>
    </div>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
    <div class="flex">
        <aside id="sidebar" class="bg-stone-800 text-white w-64 min-h-screen p-4 fixed md:relative transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-30">
            <h1 class="text-2xl font-bold text-amber-400 mb-8 text-center">Sate Maranggi</h1>
            <nav class="flex flex-col space-y-2">
                <a href="#bisnis-plan" class="sidebar-link active flex items-center py-2 px-4 rounded-lg hover:bg-amber-500 transition">
                    <span class="mr-3">üìÑ</span> Bisnis Plan
                </a>
                <a href="#resep" class="sidebar-link flex items-center py-2 px-4 rounded-lg hover:bg-amber-500 transition">
                    <span class="mr-3">üç≤</span> Panduan Resep
                </a>
                <a href="#dashboard" class="sidebar-link flex items-center py-2 px-4 rounded-lg hover:bg-amber-500 transition">
                    <span class="mr-3">üìä</span> Dashboard Penjualan
                </a>
                 <a href="#pre-order" class="sidebar-link flex items-center py-2 px-4 rounded-lg hover:bg-amber-500 transition">
                    <span class="mr-3">üì¶</span> Data Pesanan
                </a>
                <a href="#data-kas" class="sidebar-link flex items-center py-2 px-4 rounded-lg hover:bg-amber-500 transition">
                    <span class="mr-3">üí∞</span> Data Kas
                </a>
            </nav>
        </aside>

        <div class="flex-1 pb-20 md:pb-0">
            <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-10 shadow-sm flex items-center p-4 md:hidden">
                <button id="menu-btn" class="text-stone-800 mr-4">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <h2 id="header-title" class="text-xl font-bold text-amber-600">Bisnis Plan</h2>
            </header>

            <main class="p-6 md:p-8">
                <section id="bisnis-plan" class="content-section active">
                    <h2 class="text-3xl md:text-4xl font-bold mb-6">Rencana Bisnis Strategis</h2>
                    <div class="space-y-8">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-2xl font-bold mb-4">Analisis Menu & Titik Impas (BEP)</h3>
                            <div id="menu-analysis-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-2xl font-bold mb-4">Rincian Modal Awal & Operasional</h3>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <div>
                                    <h4 class="text-xl font-semibold mb-3">Biaya Investasi (Sekali Bayar)</h4>
                                    <div id="investment-cost-container" class="space-y-2">
                                        </div>
                                    <button id="add-investment-btn" class="mt-3 w-full text-sm bg-blue-100 text-blue-800 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200 transition">+ Tambah Biaya Investasi</button>
                                    <div class="flex justify-between font-bold text-lg mt-4 border-t pt-2">
                                        <span>Total Investasi:</span>
                                        <span id="total-investment">Rp 0</span>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="text-xl font-semibold mb-3">Biaya Operasional (Bulanan)</h4>
                                    <div id="operational-cost-container" class="space-y-2">
                                        </div>
                                    <button id="add-operational-btn" class="mt-3 w-full text-sm bg-blue-100 text-blue-800 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200 transition">+ Tambah Biaya Operasional</button>
                                    <div class="flex justify-between font-bold text-lg mt-4 border-t pt-2">
                                        <span>Total Operasional/Bulan:</span>
                                        <span id="total-operational">Rp 0</span>
                                    </div>
                                </div>
                            </div>
                             <div class="mt-8 border-t-2 border-amber-500 pt-4 bg-amber-50 p-4 rounded-lg">
                                <h4 class="text-xl font-bold text-amber-800">Total Modal Keseluruhan</h4>
                                <p class="text-sm text-stone-600">(Total Investasi + 1 Bulan Biaya Operasional)</p>
                                <p id="total-modal-keseluruhan" class="text-3xl font-bold text-amber-600 mt-2">Rp 0</p>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="resep" class="content-section">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl md:text-4xl font-bold">Panduan Resep</h2>
                        <button id="add-recipe-btn" class="bg-amber-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-600 transition">+ Tambah Resep</button>
                    </div>
                    <div id="recipe-container" class="space-y-8">
                        </div>
                </section>

                <section id="dashboard" class="content-section">
                    <h2 class="text-3xl md:text-4xl font-bold mb-6">Dashboard Penjualan</h2>
                    <div class="bg-white p-6 rounded-lg shadow">
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                            <div>
                                <h3 class="text-lg font-semibold text-stone-500 mb-2">Target Capaian Bulanan</h3>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-3xl font-bold text-amber-500">Rp</span>
                                    <input id="target-rupiah" type="text" placeholder="15.000.000" class="text-3xl font-bold text-amber-600 bg-amber-50 w-full focus:outline-none focus:ring-2 focus:ring-amber-300 border-none p-2 pl-12 rounded-lg">
                                </div>
                            </div>
                            <div class="md:border-l md:pl-6">
                                <label for="target-harian" class="font-semibold">Target Penjualan Harian (Porsi)</label>
                                <div class="flex items-center space-x-4 mt-2">
                                    <input id="target-harian" type="range" min="10" max="100" step="1" value="30" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-amber-500">
                                    <span id="target-harian-value" class="font-bold text-amber-600 text-lg w-24 text-right">30 Porsi</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-6">
                        <div class="bg-white p-4 rounded-lg shadow">
                            <h3 class="text-lg font-semibold text-stone-500 mb-2">Target Pemasukan Bulan Ini</h3>
                            <p id="target-bulanan" class="text-3xl font-bold text-amber-600">Rp 0</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <h3 class="text-lg font-semibold text-stone-500 mb-2">Laba Kotor Aktual</h3>
                            <p id="laba-kotor" class="text-3xl font-bold text-blue-600">Rp 0</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <h3 class="text-lg font-semibold text-stone-500 mb-2">Laba Bersih Aktual</h3>
                            <p id="laba-bersih" class="text-3xl font-bold text-green-600">Rp 0</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <h3 class="text-lg font-semibold text-stone-500 mb-2">Kekurangan Menuju Target</h3>
                            <p id="kekurangan-target" class="text-3xl font-bold text-red-500">Rp 0</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow mt-6">
                        <h3 class="text-xl font-bold mb-4">Tren Pemasukan Harian (Bulan Ini)</h3>
                        <div class="chart-container">
                            <canvas id="sales-trend-chart"></canvas>
                        </div>
                    </div>
                </section>
                
                <section id="pre-order" class="content-section">
                    <h2 class="text-3xl md:text-4xl font-bold mb-6">Data Pesanan (Pre-order)</h2>
                    <div class="bg-white p-6 rounded-lg shadow mb-8">
                        <h3 class="text-xl font-bold mb-4">Formulir Pesanan Baru</h3>
                        <form id="pre-order-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="po-customer" class="block text-sm font-bold text-stone-700 mb-1">Nama Pemesan</label>
                                    <input type="text" id="po-customer" class="bg-stone-100 w-full rounded p-3" required>
                                </div>
                                <div>
                                    <label for="po-date" class="block text-sm font-bold text-stone-700 mb-1">Tgl Pengambilan</label>
                                    <input type="date" id="po-date" class="bg-stone-100 w-full rounded p-3" required>
                                </div>
                            </div>
                            <div>
                                <label for="po-details" class="block text-sm font-bold text-stone-700 mb-1">Detail Pesanan</label>
                                <textarea id="po-details" rows="3" class="bg-stone-100 w-full rounded p-3" placeholder="Contoh: 5 porsi Sate Sapi, 2 porsi Sate Kambing" required></textarea>
                            </div>
                             <div>
                                <label for="po-amount" class="block text-sm font-bold text-stone-700 mb-1">Total Harga (Rp)</label>
                                <input type="number" id="po-amount" class="bg-stone-100 w-full rounded p-3" required>
                            </div>
                            <button type="submit" class="w-full md:w-auto bg-amber-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-600 transition">Simpan Pesanan</button>
                        </form>
                    </div>
                    <div class="flex justify-center mb-6">
                        <div class="bg-white p-4 rounded-lg shadow inline-flex space-x-6">
                            <div class="text-center">
                                <p class="text-2xl font-bold text-blue-600" id="po-proses">0</p>
                                <p class="text-sm text-stone-500">Dalam Proses</p>
                            </div>
                             <div class="text-center">
                                <p class="text-2xl font-bold text-green-600" id="po-selesai">0</p>
                                <p class="text-sm text-stone-500">Selesai</p>
                            </div>
                        </div>
                    </div>
                    <div id="pre-order-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                         </div>
                </section>

                <section id="data-kas" class="content-section">
                    <h2 class="text-3xl md:text-4xl font-bold mb-6">Data Kas</h2>
                    <div class="bg-white p-6 rounded-lg shadow mb-8">
                        <h3 class="text-xl font-bold mb-4">Formulir Transaksi</h3>
                        <form id="transaction-form" class="space-y-4">
                            <div>
                                <label for="tx-date" class="block text-sm font-bold text-stone-700 mb-1">Tanggal</label>
                                <input type="date" id="tx-date" class="bg-stone-100 p-3 mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-amber-500 focus:ring-amber-500" required>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="tx-type" class="block text-sm font-bold text-stone-700 mb-1">Jenis</label>
                                    <select id="tx-type" class="bg-stone-100 p-3 mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-amber-500 focus:ring-amber-500">
                                        <option>Pemasukan</option>
                                        <option>Pengeluaran</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="tx-category" class="block text-sm font-bold text-stone-700 mb-1">Kategori</label>
                                    <select id="tx-category" class="bg-stone-100 p-3 mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-amber-500 focus:ring-amber-500"></select>
                                </div>
                            </div>
                            <div>
                                <label for="tx-amount" class="block text-sm font-bold text-stone-700 mb-1">Jumlah (Rp)</label>
                                <input type="number" id="tx-amount" placeholder="50000" class="bg-stone-100 p-3 mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-amber-500 focus:ring-amber-500" required>
                            </div>
                            <button type="submit" class="w-full bg-amber-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-amber-600 transition">Tambah Transaksi</button>
                        </form>
                    </div>
                    <div id="transaction-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        </div>
                </section>
            </main>
        </div>
    </div>
    
    <div id="edit-tx-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center"> </div>
    <div id="kelola-menu-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center"> </div>
    <div id="recipe-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center"> </div>
    
    <nav id="bottom-nav" class="md:hidden fixed bottom-0 inset-x-0 bg-stone-800 text-white flex justify-around shadow-lg z-20 rounded-t-lg">
        <a href="#dashboard" class="bottom-nav-link p-2 w-full text-center rounded-tl-lg">üìä<span class="block text-xs">Dasbor</span></a>
        <a href="#data-kas" class="bottom-nav-link p-2 w-full text-center">üí∞<span class="block text-xs">Data Kas</span></a>
        <a href="#pre-order" class="bottom-nav-link p-2 w-full text-center">üì¶<span class="block text-xs">Pesanan</span></a>
        <a href="#resep" class="bottom-nav-link p-2 w-full text-center">üç≤<span class="block text-xs">Resep</span></a>
        <a href="#bisnis-plan" class="bottom-nav-link p-2 w-full text-center rounded-tr-lg">üìÑ<span class="block text-xs">Bisnis</span></a>
    </nav>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
        // ===================================================================================
        // PASTE KONFIGURASI FIREBASE ANDA DI SINI
        // ===================================================================================
    // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCRCGwEFeP5y0HP21pGi3yGJLPsgGH-tTc",
  authDomain: "dasbor-sate.firebaseapp.com",
  projectId: "dasbor-sate",
  storageBucket: "dasbor-sate.firebasestorage.app",
  messagingSenderId: "211008815272",
  appId: "1:211008815272:web:269596e4916036274a029d",
  measurementId: "G-5W8BKVNL1R"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
        // ===================================================================================

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
// FUNGSI UNTUK RESET DATA AWAL SECARA MANUAL
function resetDataAwal() {
    console.log('Mencoba menyimpan data awal ke Firestore...');

    // Data awal default yang akan kita masukkan
    const dataAwal = {
        modal: {
            investment: [{ name: "Gerobak / Tenda", cost: 1500000 }, { name: "Alat Bakar", cost: 300000 }, { name: "Kompor & Gas", cost: 250000 }, { name: "Peralatan Masak & Makan", cost: 400000 }, { name: "Banner", cost: 100000 }],
            operational: [{ name: "Sewa Lapak", cost: 300000 }, { name: "Transportasi", cost: 200000 }, { name: "Gas & Arang", cost: 150000 }]
        },
        hariKerjaPerBulan: 25,
        targetBulananRp: 15000000,
        menu: [
            { 
                id: 'sate-sapi', name: 'Sate Maranggi Sapi', hargaJual: 30000,
                hppBreakdown: [{ name: 'Daging Sapi (100gr)', cost: 14000 }, { name: 'Bumbu & Kecap', cost: 5000 }, { name: 'Nasi/Lontong', cost: 2500 }, { name: 'Kemasan & Lainnya', cost: 1500 }],
                resep: { C1_label: "Bumbu Marinasi", C1_content: "Bawang Merah: 10 siung\nBawang Putih: 8 siung\nLengkuas: 3 cm\nKetumbar Sangrai: 2 sdt", C2_label: "Sambal", C2_content: "Tomat Merah: 3 buah\nCabai Rawit: 15-20 buah", C3_label: "Langkah Pembuatan", C3_content: "Campur daging dengan bumbu halus.\nMarinasi di kulkas minimal 3 jam."}
            }
        ],
        categories: { Pemasukan: ["Penjualan Harian", "Penjualan Pre-order"], Pengeluaran: ["Bahan Baku", "Sewa Lapak", "Operasional", "Transportasi", "Lain-lain"] }
    };

    // Perintah untuk menyimpan ke Firestore
    db.collection('businessConfig').doc('main').set(dataAwal)
      .then(() => {
          console.log("SUKSES! Data awal berhasil disimpan.");
          alert("SUKSES! Data awal berhasil disimpan. Silakan refresh halaman.");
          location.reload(); // Otomatis refresh halaman
      })
      .catch(error => {
          console.error("ERROR saat menyimpan data awal: ", error);
          alert("ERROR! Gagal menyimpan data awal. Cek console untuk detail.");
      });
}
        document.addEventListener('DOMContentLoaded', function () {
            // Data Lokal (tidak disimpan di DB, bisa diubah sesuai kebutuhan)
            let businessData = {
                modal: {
                    investment: [{ name: "Gerobak / Tenda", cost: 1500000 }, { name: "Alat Bakar", cost: 300000 }],
                    operational: [{ name: "Sewa Lapak", cost: 300000 }, { name: "Transportasi", cost: 200000 }]
                },
                hariKerjaPerBulan: 25,
                targetBulananRp: 15000000,
                menu: [
                    { 
                        id: 'sate-sapi', name: 'Sate Maranggi Sapi', hargaJual: 30000,
                        hppBreakdown: [{ name: 'Daging Sapi (100gr)', cost: 14000 }, { name: 'Bumbu & Kecap', cost: 5000 }],
                        resep: { C1_label: "Bumbu Marinasi", C1_content: "Bawang Merah: 10 siung\nBawang Putih: 8 siung", C2_label: "Sambal", C2_content: "Tomat Merah: 3 buah\nCabai Rawit: 15-20 buah", C3_label: "Langkah Pembuatan", C3_content: "Campur daging dengan bumbu halus.\nMarinasi di kulkas minimal 3 jam."}
                    }
                ],
                categories: { Pemasukan: ["Penjualan Harian", "Penjualan Pre-order"], Pengeluaran: ["Bahan Baku", "Sewa Lapak", "Operasional", "Transportasi", "Lain-lain"] }
            };

            // Variabel Global untuk menampung data dari Firestore
            let transactions = [];
            let preOrders = [];
            let salesTrendChart;

            const formatCurrency = (value) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(value);
            const formatNumber = (value) => new Intl.NumberFormat('id-ID').format(value);

            const DOMElements = {
                sidebar: document.getElementById('sidebar'), sidebarOverlay: document.getElementById('sidebar-overlay'), menuBtn: document.getElementById('menu-btn'), headerTitle: document.getElementById('header-title'),
                sidebarLinks: document.querySelectorAll('.sidebar-link'), contentSections: document.querySelectorAll('.content-section'),
                bottomNavLinks: document.querySelectorAll('.bottom-nav-link'),
                targetHarianSlider: document.getElementById('target-harian'), targetHarianValue: document.getElementById('target-harian-value'),
                targetBulananEl: document.getElementById('target-bulanan'), labaKotorEl: document.getElementById('laba-kotor'),
                labaBersihEl: document.getElementById('laba-bersih'), kekuranganTargetEl: document.getElementById('kekurangan-target'),
                txForm: document.getElementById('transaction-form'), txDate: document.getElementById('tx-date'),
                txType: document.getElementById('tx-type'), txCategory: document.getElementById('tx-category'), txAmount: document.getElementById('tx-amount'),
                transactionList: document.getElementById('transaction-list'), recipeContainer: document.getElementById('recipe-container'),
                menuAnalysisContainer: document.getElementById('menu-analysis-container'), editTxModal: document.getElementById('edit-tx-modal'),
                kelolaMenuModal: document.getElementById('kelola-menu-modal'), recipeModal: document.getElementById('recipe-modal'),
                targetRupiahInput: document.getElementById('target-rupiah'), addRecipeBtn: document.getElementById('add-recipe-btn'),
                preOrderForm: document.getElementById('pre-order-form'), preOrderList: document.getElementById('pre-order-list'),
                poProses: document.getElementById('po-proses'), poSelesai: document.getElementById('po-selesai'),
                toast: document.getElementById('toast-notification'), toastMessage: document.getElementById('toast-message'),
            };

            function showToast(message) {
                DOMElements.toastMessage.textContent = message;
                DOMElements.toast.classList.add('show');
                setTimeout(() => {
                    DOMElements.toast.classList.remove('show');
                }, 3000);
            }

            function toggleSidebar() { DOMElements.sidebar.classList.toggle('-translate-x-full'); DOMElements.sidebarOverlay.classList.toggle('hidden'); }
            
            // Fungsi render tidak berubah banyak, hanya sumber datanya (variabel global)
            // yang diisi oleh listener Firestore
            function renderAll() {
                renderTransactions();
                renderRecipes();
                renderMenuAnalysis();
                renderCapitalPlan();
                renderPreOrders();
                updateDashboard();
            }

            function setupNavigation() {
                const allLinks = [...DOMElements.sidebarLinks, ...DOMElements.bottomNavLinks];
                DOMElements.menuBtn.addEventListener('click', toggleSidebar);
                DOMElements.sidebarOverlay.addEventListener('click', toggleSidebar);
                
                allLinks.forEach(link => {
                    link.addEventListener('click', e => {
                        e.preventDefault();
                        const targetId = link.getAttribute('href').substring(1);

                        DOMElements.contentSections.forEach(s => s.classList.remove('active'));
                        document.getElementById(targetId).classList.add('active');

                        allLinks.forEach(l => l.classList.remove('active'));
                        // Menambahkan kelas 'active' ke link yang diklik di sidebar dan bottom nav
                        document.querySelectorAll(`[href="#${targetId}"]`).forEach(activeLink => activeLink.classList.add('active'));

                        DOMElements.headerTitle.textContent = link.textContent.trim().replace(/[\d\süìäüí∞üì¶üç≤üìÑ]/g, '');
                        if (window.innerWidth < 768 && DOMElements.sidebar.classList.contains('-translate-x-full') === false) {
                            toggleSidebar();
                        }
                        window.scrollTo(0, 0);
                    });
                });
            }

            function populateCategories(selectEl, type) {
                selectEl.innerHTML = '';
                businessData.categories[type].forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat; option.textContent = cat;
                    selectEl.appendChild(option);
                });
            }

            // ===========================================================================
            // FUNGSI-FUNGSI UTAMA YANG BERINTERAKSI DENGAN FIREBASE
            // ===========================================================================

            // MENAMBAH Transaksi
            function addTransaction(e) {
                e.preventDefault();
                const newTransaction = {
                    date: DOMElements.txDate.value,
                    type: DOMElements.txType.value,
                    category: DOMElements.txCategory.value,
                    amount: parseInt(DOMElements.txAmount.value) || 0
                };
                db.collection('transactions').add(newTransaction)
                    .then(() => {
                        showToast("Transaksi berhasil ditambahkan!");
                        DOMElements.txForm.reset();
                        DOMElements.txDate.valueAsDate = new Date();
                    })
                    .catch(error => console.error("Error: ", error));
            }

            // MENGHAPUS Transaksi
            function deleteTransaction(id) {
                if(confirm('Yakin ingin menghapus transaksi ini?')) {
                    db.collection('transactions').doc(id).delete()
                    .then(() => showToast("Transaksi berhasil dihapus!"))
                    .catch(error => console.error("Error: ", error));
                }
            }
            
            // MENYIMPAN EDIT Transaksi
            function saveEditTransaction(e) {
                e.preventDefault();
                const id = e.target.querySelector('#edit-tx-id').value;
                const updatedTx = {
                    date: e.target.querySelector('#edit-tx-date').value,
                    category: e.target.querySelector('#edit-tx-category').value,
                    amount: parseInt(e.target.querySelector('#edit-tx-amount').value) || 0,
                };
                db.collection('transactions').doc(id).update(updatedTx)
                    .then(() => {
                        showToast("Transaksi berhasil diperbarui!");
                        DOMElements.editTxModal.classList.add('hidden');
                    })
                    .catch(error => console.error("Error: ", error));
            }
            
            // MENAMBAH Pre-Order
            function addPreOrder(e) {
                e.preventDefault();
                const newOrder = {
                    customer: DOMElements.preOrderForm.querySelector('#po-customer').value,
                    date: DOMElements.preOrderForm.querySelector('#po-date').value,
                    details: DOMElements.preOrderForm.querySelector('#po-details').value,
                    amount: parseInt(DOMElements.preOrderForm.querySelector('#po-amount').value) || 0,
                    status: 'proses'
                };
                db.collection('preOrders').add(newOrder)
                    .then(() => {
                        showToast("Pesanan baru berhasil disimpan!");
                        DOMElements.preOrderForm.reset();
                    })
                    .catch(error => console.error("Error: ", error));
            }

            // MENYELESAIKAN Pre-Order
            function completePreOrder(id) {
                const order = preOrders.find(o => o.id === id);
                if (order) {
                    db.collection('preOrders').doc(id).update({ status: 'selesai' })
                        .then(() => {
                             const newTransaction = {
                                date: new Date().toISOString().split('T')[0],
                                type: 'Pemasukan',
                                category: 'Penjualan Pre-order',
                                amount: order.amount
                            };
                            return db.collection('transactions').add(newTransaction);
                        })
                        .then(() => showToast(`Pesanan ${order.customer} selesai!`))
                        .catch(error => console.error("Error completing order: ", error));
                }
            }
            
            // Untuk data businessData, kita simpan sebagai satu dokumen saja agar mudah.
            // Kita beri ID 'main' agar selalu mengupdate dokumen yang sama.
            function saveBusinessData() {
                db.collection('businessConfig').doc('main').set(businessData)
                  .then(() => console.log("Business data saved to Firestore."))
                  .catch(error => console.error("Error saving business data: ", error));
            }
            

            // ===========================================================================
            // FUNGSI-FUNGSI RENDER (TAMPILAN) - TIDAK BANYAK BERUBAH
            // ===========================================================================
            function renderTransactions() {
                const container = DOMElements.transactionList;
                container.innerHTML = '';
                if (transactions.length === 0) {
                    container.innerHTML = `<p class="text-stone-500 italic md:col-span-3">Belum ada transaksi.</p>`;
                    return;
                }
                // Firestore sudah kita minta urutkan, jadi tidak perlu sort manual lagi
                transactions.forEach(tx => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-lg shadow';
                    const isPemasukan = tx.type === 'Pemasukan';
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold">${tx.category}</p>
                                <p class="text-sm text-stone-500">${new Date(tx.date).toLocaleDateString('id-ID')}</p>
                            </div>
                            <p class="font-bold text-lg ${isPemasukan ? 'text-green-600' : 'text-red-600'}">${isPemasukan ? '+' : '-'} ${formatCurrency(tx.amount)}</p>
                        </div>
                        <div class="text-right mt-2">
                            <button data-id="${tx.id}" class="edit-btn text-blue-500 hover:underline text-xs font-semibold">Edit</button>
                            <button data-id="${tx.id}" class="delete-btn text-red-500 hover:underline text-xs font-semibold ml-2">Hapus</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }

            function renderPreOrders() {
                const container = DOMElements.preOrderList;
                container.innerHTML = '';
                const activeOrders = preOrders.filter(o => o.status === 'proses');
                if (activeOrders.length === 0) {
                    container.innerHTML = `<p class="text-stone-500 italic md:col-span-3">Tidak ada pesanan aktif.</p>`;
                } else {
                    activeOrders.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(order => {
                        const card = document.createElement('div');
                        card.className = 'bg-white p-4 rounded-lg shadow flex flex-col';
                        card.innerHTML = `
                            <h4 class="font-bold">${order.customer}</h4>
                            <p class="text-sm text-stone-500 mb-2">Ambil: ${new Date(order.date).toLocaleDateString('id-ID')}</p>
                            <p class="text-sm text-stone-700 flex-grow whitespace-pre-wrap">${order.details}</p>
                            <p class="font-bold text-amber-600 mt-2">${formatCurrency(order.amount)}</p>
                            <button data-id="${order.id}" class="complete-po-btn mt-4 w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition">Selesaikan Pesanan</button>
                        `;
                        container.appendChild(card);
                    });
                }
                DOMElements.poProses.textContent = preOrders.filter(o => o.status === 'proses').length;
                DOMElements.poSelesai.textContent = preOrders.filter(o => o.status === 'selesai').length;
            }
            
             // ==========================================================================================
            // SISANYA ADALAH FUNGSI-FUNGSI YANG SAMA SEPERTI KODE LAMA ANDA
            // Tidak perlu diubah karena mereka hanya membaca dari variabel businessData
            // dan tidak berinteraksi langsung dengan penyimpanan data.
            // ==========================================================================================

            function updateDashboard() {
                const targetBulananRp = businessData.targetBulananRp || 0;
                DOMElements.targetBulananEl.textContent = formatCurrency(targetBulananRp);

                const now = new Date();
                const monthlyTx = transactions.filter(tx => {
                    const txDate = new Date(tx.date);
                    return txDate.getMonth() === now.getMonth() && txDate.getFullYear() === now.getFullYear();
                });

                const totalPemasukan = monthlyTx.filter(tx => tx.type === 'Pemasukan').reduce((s, tx) => s + tx.amount, 0);
                const totalPengeluaran = monthlyTx.filter(tx => tx.type === 'Pengeluaran').reduce((s, tx) => s + tx.amount, 0);
                const totalBiayaOperasional = businessData.modal.operational.reduce((sum, item) => sum + (item.cost || 0), 0);
                const labaKotor = totalPemasukan - totalPengeluaran;
                const labaBersih = labaKotor; // Laba bersih dihitung dari laba kotor saja, operasional bulanan sudah masuk pengeluaran
                const kekurangan = Math.max(0, targetBulananRp - totalPemasukan);
                
                DOMElements.labaKotorEl.textContent = formatCurrency(labaKotor);
                DOMElements.labaBersihEl.textContent = formatCurrency(labaBersih);
                DOMElements.kekuranganTargetEl.textContent = formatCurrency(kekurangan);
                updateSalesTrendChart();
            }

            function openEditModal(id) {
                const tx = transactions.find(t => t.id === id);
                DOMElements.editTxModal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md m-4">
                    <h3 class="text-2xl font-bold mb-4">Edit Transaksi</h3>
                    <form id="edit-tx-form">
                        <input type="hidden" id="edit-tx-id" value="${tx.id}">
                        <div class="space-y-4">
                            <div><label for="edit-tx-date" class="block text-sm font-bold text-stone-700 mb-1">Tanggal</label><input type="date" id="edit-tx-date" value="${tx.date}" class="bg-stone-50 mt-1 block w-full rounded-md border-stone-300 shadow-sm" required></div>
                            <div><label for="edit-tx-category" class="block text-sm font-bold text-stone-700 mb-1">Kategori</label><select id="edit-tx-category" class="bg-stone-50 mt-1 block w-full rounded-md border-stone-300 shadow-sm"></select></div>
                            <div><label for="edit-tx-amount" class="block text-sm font-bold text-stone-700 mb-1">Jumlah (Rp)</label><input type="number" id="edit-tx-amount" value="${tx.amount}" class="bg-stone-50 mt-1 block w-full rounded-md border-stone-300 shadow-sm" required></div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" class="cancel-modal-btn bg-stone-200 text-stone-800 font-bold py-2 px-4 rounded-lg hover:bg-stone-300">Batal</button>
                            <button type="submit" class="bg-amber-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-600">Simpan</button>
                        </div>
                    </form>
                </div>`;
                const catSelect = DOMElements.editTxModal.querySelector('#edit-tx-category');
                populateCategories(catSelect, tx.type);
                catSelect.value = tx.category;
                DOMElements.editTxModal.classList.remove('hidden');
                DOMElements.editTxModal.classList.add('flex');
            }
            
            function createSalesTrendChart() {
                const ctx = document.getElementById('sales-trend-chart').getContext('2d');
                if (salesTrendChart) { salesTrendChart.destroy(); }
                salesTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [{ label: 'Pemasukan Harian', data: [], backgroundColor: 'rgba(245, 158, 11, 0.2)', borderColor: 'rgba(245, 158, 11, 1)', borderWidth: 2, tension: 0.3, fill: true }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                });
            }

            function updateSalesTrendChart() {
                if(!salesTrendChart) return;
                const now = new Date();
                const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                const labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
                const data = Array(daysInMonth).fill(0);

                transactions.forEach(tx => {
                    const txDate = new Date(tx.date);
                    if (tx.type === 'Pemasukan' && txDate.getMonth() === now.getMonth() && txDate.getFullYear() === now.getFullYear()) {
                        const dayOfMonth = txDate.getDate();
                        if(dayOfMonth > 0 && dayOfMonth <= daysInMonth) {
                           data[dayOfMonth - 1] += tx.amount;
                        }
                    }
                });
                
                salesTrendChart.data.labels = labels;
                salesTrendChart.data.datasets[0].data = data;
                salesTrendChart.update();
            }

            // (Sisa fungsi render menu, resep, modal, dll. sama seperti kode lama Anda)
            // Saya singkat di sini agar tidak terlalu panjang, tapi di file Anda,
            // biarkan fungsi-fungsi tersebut tetap ada.
            function renderRecipes() { /* ... kode sama ... */ }
            function openRecipeModal(menuId = null) { /* ... kode sama ... */ }
            function saveRecipe(e) { /* ... kode sama ... */ }
            function deleteRecipe(id) { /* ... kode sama ... */ }
            function renderMenuAnalysis() { /* ... kode sama ... */ }
            function renderCapitalPlan() { /* ... kode sama ... */ }
            function updateCapitalTotals() { /* ... kode sama ... */ }
            function openKelolaMenuModal(menuId) { /* ... kode sama ... */ }
            function saveKelolaMenu(e) { /* ... kode sama ... */ }
            function updateTargetSlider() { /* ... kode sama ... */ }


            // ===========================================================================
            // INITIALIZE - TITIK AWAL APLIKASI
            // ===========================================================================
            function initialize() {
                setupNavigation();
                DOMElements.txDate.valueAsDate = new Date();
                DOMElements.preOrderForm.querySelector('#po-date').valueAsDate = new Date();
                populateCategories(DOMElements.txCategory, 'Pemasukan');
                createSalesTrendChart();

                // Listener untuk data businessConfig (hanya sekali load)
                db.collection('businessConfig').doc('main').get().then(doc => {
                    if (doc.exists) {
                        businessData = doc.data();
                        console.log("Business data loaded from Firestore.");
                    } else {
                        // Jika belum ada, simpan data default ke Firestore
                        console.log("No business data found. Saving default config.");
                        saveBusinessData();
                    }
                    // Setelah data config dimuat, render semua komponen yang bergantung padanya
                    DOMElements.targetRupiahInput.value = formatNumber(businessData.targetBulananRp);
                    renderAll();
                    updateTargetSlider();
                }).catch(error => console.error("Error loading business data: ", error));


                // Listener REAL-TIME untuk TRANSACTIONS
                db.collection('transactions').orderBy('date', 'desc').onSnapshot(snapshot => {
                    transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderTransactions();
                    updateDashboard();
                });

                // Listener REAL-TIME untuk PRE-ORDERS
                db.collection('preOrders').onSnapshot(snapshot => {
                    preOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderPreOrders();
                });

                // Event Listeners (sama seperti kode lama Anda)
                document.addEventListener('submit', e => {
                    if(e.target.matches('#transaction-form')) addTransaction(e);
                    if(e.target.matches('#pre-order-form')) addPreOrder(e);
                    if(e.target.matches('#edit-tx-form')) saveEditTransaction(e);
                    // ... tambahkan event submit lain jika ada
                });

                document.addEventListener('click', e => {
                    if(e.target.matches('.delete-btn')) deleteTransaction(e.target.dataset.id);
                    if(e.target.matches('.edit-btn')) openEditModal(e.target.dataset.id);
                    if(e.target.matches('.complete-po-btn')) completePreOrder(e.target.dataset.id);
                    if(e.target.matches('.cancel-modal-btn')) e.target.closest('.modal').classList.add('hidden');
                    // ... tambahkan event click lain
                });

                // Listener untuk input target rupiah yang akan menyimpan perubahan ke DB
                DOMElements.targetRupiahInput.addEventListener('change', (e) => {
                    businessData.targetBulananRp = parseInt(e.target.value.replace(/\./g, '')) || 0;
                    saveBusinessData(); // Simpan ke Firestore
                    updateDashboard();
                    updateTargetSlider();
                });
            }

            initialize();
        });
    </script>
</body>

</html>

